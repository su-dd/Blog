---
title: 基于Cola的DDD实践
date: 2022-05-05 13:39:02
permalink: /pages/e880df/
categories:
  - 领域驱动设计
tags:
  - DDD
  - COLA
---
前面两篇，陆续介绍了：值对象、DP、实体、领域服务、应用服务；这篇是希望将领域模型的理论，应用到实战。 

> 因为需要从实践的角度；所以阅读这篇需要一些想象力，如果有问题，欢迎沟通。

既然要应用到实战，这里不经要问一个问题： **距离实战，还有多少差距？**

## 业务要求

> 1、活动策划可以查看所有用户信息，并可以通过，手机号码、姓名、身份证、销售信息 这四个信息里的一个或多个来查找用户，显示姓名，号码。
> 
> 2、活动策划可以查看用户的详细信息，显示：姓名，号码，身份证，新手福利信息；并修改用户的新手福利。
> 
> 3、用户可以自行注销账号。

## 常见代码

**应用服务：**
```java
@Service
public class UserServiceImpl implements UserService {
    @Autowired
    private UserRepo userRepo;
    @Autowired
    private CheckUserService checkUserService;
    @Autowired
    private RealnameService realnameService;

    @Override
    public UserDTO register(Name name, PhoneNumber phone) throws ValidationException {
        // 查询实名信息(实名信息验证)
        RealnameInfo realnameInfo = realnameService.get(name, phone);
        // 构造对象
        User user = new User(realnameInfo, phone);
        // 检查User对象
        checkUserService.check(user);
        return new UserDTO(userRepo.save(user));
    }

    @Override
    public List<UserDTO> findList(UserParamDTO userParamDTO) {
        List<User> userList = userRepo.find(userParamDTO);
        List<UserDTO> userDTOList = new ArrayList<>();
        userList.forEach(user -> {
            userDTOList.add(new UserDTO(user));
        });
        return userDTOList;
    }

    @Override
    public UserDTO find(UserParamDTO userParamDTO) {
        if (null == userParamDTO.getUserId() || userParamDTO.getUserId().length() == 0) {
            return null;
        }
        User user = userRepo.findById(userParamDTO.getUserId());
        if (null != user) {
            return new UserDTO(user);
        }
        return null;
    }

    @Override
    public UserDTO setFresh(UserParamDTO userParamDTO) {
        if (null == userParamDTO.getUserId() || userParamDTO.getUserId().length() == 0) {
            return null;
        }
        User user = userRepo.findById(userParamDTO.getUserId());
        if (null != user) {
            // 设置用户为新客身份，以便发送新手礼包
            user.setFresh(true);
            // 检查User对象
            checkUserService.check(user);
            return new UserDTO(user);
        }
        return null;
    }

    @Override
    public Boolean deleteOne(UserParamDTO userParamDTO) {
        if (null == userParamDTO.getUserId() || userParamDTO.getUserId().length() == 0) {
            return false;
        }
        return userRepo.delete(userParamDTO.getUserId());
    }
}
```

## 认识问题

**1、随着不断的提取概念，经典的3层结构不能很好的容纳这些概念。**
当前的3层结构，不能很好的容纳新提出的概念。


**2、应用服务不断被修改，有业务外流的风险；也不符合开闭原则。**

现在的应用服务，里存在着大量的查询逻辑；每次的修改都有可能对UserService造成破坏。

**3、多个请求使用一个DTO，导致DTO臃肿**

现在的UserParamDTO，被多个业务使用。导致DTO的臃肿，在传输中需要填充并不需要的字段。
```java
@Data
public class UserParamDTO implements Serializable {
    // 用户id
    private String userId;
    // 用户名称
    private String name;
    // 用户手机
    private String phone;
    //绑定销售id
    private String salesId;
    // 标志是否为新用户，默认为false
    private Boolean fresh;
}
```




![分层架构](https://idai.coding.net/p/blog/d/cdn/git/raw/main/博客/知识总结/架构设计/DDD/分层架构.webp)